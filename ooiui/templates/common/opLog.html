{% extends "common/base.html" %}
{% block head %}
{% block title %}
<title>Operations Log</title>
{% endblock %}
<link rel="stylesheet" href="/css/compiled/basic.css" type="text/css" />
<link rel="stylesheet" href="/css/common/timeline.css" type="text/css" />
<link rel="stylesheet" href="/css/compiled/opLog.css" type="text/css" />
<!-- Partials -->
<script src="/js/partials/compiled/OpLog.js" type="text/javascript"></script>
<script src="/js/compiled/opLog.js" type="text/javascript"></script>


{% endblock %}

{%block body %}
<div id="wrapper" class="org-sidebar-wrapper">
  <div id="sidebar-wrapper" class="navbar-default org-sidebar">
  </div>
  <div id="page-content-wrapper">
    <div class="row">
      <div id="log-search-view" class="col-lg-12">
      </div>
    </div>
    <div class="row">
      <div id="log-timeline" class="cssanimations timeline col-lg-12"></div>
    </div>
  </div>
</div>

<script type="text/javascript">
/*
 * OOI is the main class that we extend from to create behavior and render pages.
 *
 * Here we create the application by extending OOI with Backbone.Events, this
 * gives us the ability to listen to events from models and/or views. When we
 * hear these events the main application can then trigger another view to
 * render, or in this case cause a collection to be fetched as a result.
 */

_.extend(OOI.prototype, Backbone.Events,  {
  login: new LoginModel(),
  // Models and collections
  collections: {
    // Instantiate a new Organizations collection
    organizations: new Organizations(),
    logEntries: new LogEntryCollection(),
    logComments: new LogEntryCommentCollection()
  },
  models: {
    orgModel: new OrganizationModel(),
    userModel: new UserModel()
  },
  views: {
    orgSidebarView: null,
    logSearchView: null,
    timelineView: null
  },
  start: function() {
    /* Login stuff */
    this.login.fetch({async:false});
    this.views.navbar = new NavbarView();
    $('body').prepend(this.views.navbar.el);

    if(this.login.loggedIn()) {
      this.models.userModel.fetch({url: '/api/current_user'});      
    }

    /* Views */
    this.views.orgSidebarView = new OrgSidebarView({
      collection: this.collections.organizations,
      userModel: this.models.userModel
    });
    $('#sidebar-wrapper').html(this.views.orgSidebarView.el);

    this.views.logSearchView = new LogSearchView({
      el: $('#log-search-view')
    });
    this.views.logSearchView.render();

    this.views.timelineView = new TimelineView({
      el: $('#log-timeline')
    });
    this.views.timelineView.render();

  },
  eventListeners:function() {
    this.listenTo(this, "org:click", this.orgSelection);
    this.listenTo(this, "login:success", this.onLogin);
    this.listenTo(this, "login:logout", this.onLogout);
    this.listenTo(this.models.userModel, 'change', function(model){      
      this.views.orgSidebarView.selectOrg(model.get('organization_id'));
    });
  },

  onLogin: function() {
    location.reload();
  },
  onLogout: function() {
    location.reload();
  },
  /*
   * orgSelection is called by the event listener for org:click. The trigger
   * from the OrgSidebarView passes the organization_id in as a parameter. With
   * this we can cause the WatchView to re-render with the new watches we'll
   * fetch, using the organization_id as a query parameter.
   */
  orgSelection: function(organization_id) {
    this.models.orgModel.set({id: organization_id});
    this.models.orgModel.fetch();
  },
  test: function() {
    var logEntry = new LogEntryModel({
      log_entry_type: "INFO",
      entry_title: "Another Entry",
      entry_description: "これもいつか過ぎ去るものです。"
    });
    var promise = logEntry.save();
    $.when(promise).done(function(){
      console.log("Saved");
    });
  }
});
// Instantiate the application for this page
var ooi = new OOI();

$(document).ready(function() {
  // Once the DOM is loaded, we start our application
  ooi.start();
  ooi.test();
	var $timeline_block = $('.cd-timeline-block');

	//hide timeline blocks which are outside the viewport
	$timeline_block.each(function(){
    console.log($(this).offset());
    console.log($(window).scrollTop());
		if($(this).offset().top > $(window).scrollTop()+$(window).height()*0.75) {
      console.log("Hiding element");
			$(this).find('.cd-timeline-img, .cd-timeline-content').addClass('is-hidden');
		}
	});

	//on scolling, show/animate timeline blocks when enter the viewport
	$(window).on('scroll', function(){
		$timeline_block.each(function(){
      /*
      console.log("timeline offset", $(this).offset().top);
      console.log("window scroll top", $(window).scrollTop());
      console.log("window height", $(window).height());
      */
			if( $(this).offset().top <= $(window).scrollTop()+$(window).height()*0.75 && $(this).find('.cd-timeline-img').hasClass('is-hidden') ) {
        console.log("element outside viewport");
				$(this).find('.cd-timeline-img, .cd-timeline-content').removeClass('is-hidden').addClass('bounce-in');
			}
		});
	});
});


</script>

{% endblock %}
